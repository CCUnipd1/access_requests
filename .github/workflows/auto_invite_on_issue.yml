name: Auto Invite on Access Request

on:
  issues:
    types: [opened]

jobs:
  auto-invite:
    if: github.event.issue.title == 'request-P4s5w0rD'
    runs-on: ubuntu-latest

    steps:
    - name: Get user ID and invite
      env:
        GH_TOKEN: ${{ secrets.ORG_INVITATION_SECRET }}
        ORG_NAME: CCUnipd1  
      run: |
        USERNAME=${{ github.event.issue.user.login }}
        echo "üîç Getting ID for user $USERNAME..."

        USER_ID=$(curl -s \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/users/$USERNAME | jq '.id')

        echo "üë§ User ID is $USER_ID"

        echo "üöÄ Sending invitation to $USERNAME (ID: $USER_ID)..."
        curl -L -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/orgs/$ORG_NAME/invitations \
          -d "{\"invitee_id\":$USER_ID,\"role\":\"direct_member\"}"

    - name: Mask, transfer, and close issue
      env:
        GH_TOKEN: ${{ secrets.ORG_INVITATION_SECRET }}
        REPO: ${{ github.repository }}
        NEW_REPO: CCUnipd1/manage_issue  # Inserisci il percorso corretto owner/repo
        ISSUE_NUMBER: ${{ github.event.issue.number }}
      run: |
        echo "$GH_TOKEN" | gh auth login --with-token
      
        # Trasferisce la issue
        gh issue transfer "$ISSUE_NUMBER" \
          --repo "$REPO" \
          --target-repo "$NEW_REPO"
      
        # Recupera nuovo numero issue (assume una sola issue aperta nella repo di destinazione)
        NEW_ISSUE_NUMBER=$(gh issue list \
          --repo "$NEW_REPO" \
          --state open \
          --limit 1 \
          --json number \
          --jq '.[0].number')
      
        # Commenta e chiude la nuova issue
        gh issue comment "$NEW_ISSUE_NUMBER" \
          --repo "$NEW_REPO" \
          --body "‚úÖ Invitation sent and issue moved securely."
      
        gh issue close "$NEW_ISSUE_NUMBER" \
          --repo "$NEW_REPO"




